name: StegVerse SCW Orchestrator

on:
  workflow_dispatch:
    inputs:
      command:
        description: "SCW command to run (self-test, autopatch)"
        required: true
        default: "self-test"
      target_repo:
        description: "Full repo name to operate on (e.g. StegVerse-Labs/TVC)"
        required: true
      org:
        description: "Owning org of the target repo (StegVerse or StegVerse-Labs)"
        required: true
        default: "StegVerse-Labs"
      base_branch:
        description: "Base branch for autopatch (default: main)"
        required: false
        default: "main"
      dry_run:
        description: "Run without pushing changes (true/false)"
        required: false
        default: "false"
      allowlist:
        description: "Optional comma-separated repo allowlist"
        required: false

permissions:
  contents: write
  pull-requests: write

jobs:
  SCW:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout SCW repo
        uses: actions/checkout@v4

      - name: Map GH token and validate presence (required for SCW)
        id: map_token
        run: |
          echo "Resolving GH token for org: ${{ github.event.inputs.org }}"

          if [ "${{ github.event.inputs.org }}" = "StegVerse-Labs" ]; then
            echo "Using Labs token"
            echo "GH_TOKEN=${{ secrets.GH_STEGVERSE_LABS_AI_TOKEN }}" >> $GITHUB_ENV
          else
            echo "Using StegVerse token"
            echo "GH_TOKEN=${{ secrets.GH_STEGVERSE_AI_TOKEN }}" >> $GITHUB_ENV
          fi

          if [ -z "${{ env.GH_TOKEN }}" ]; then
            echo "::error title=Missing Token::No GitHub token available. Check org and secrets."
            exit 1
          fi

      - name: Resolve inputs (supports workflow_dispatch)
        id: resolve_inputs
        run: |
          CMD="${{ github.event.inputs.command }}"
          TARGET="${{ github.event.inputs.target_repo }}"
          ORG="${{ github.event.inputs.org }}"
          BASE="${{ github.event.inputs.base_branch }}"
          DRY="${{ github.event.inputs.dry_run }}"
          ALLOW="${{ github.event.inputs.allowlist }}"

          echo "command: $CMD"
          echo "target_repo: $TARGET"
          echo "org: $ORG"
          echo "base_branch: $BASE"
          echo "dry_run: $DRY"
          echo "allowlist: $ALLOW"

          echo "CMD=$CMD" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "ORG=$ORG" >> $GITHUB_ENV
          echo "BASE=$BASE" >> $GITHUB_ENV
          echo "DRY=$DRY" >> $GITHUB_ENV
          echo "ALLOW=$ALLOW" >> $GITHUB_ENV

      - name: Set git identity (required for autopatch commits)
        run: |
          git config --global user.name "StegVerse-AI"
          git config --global user.email "ai@stegverse.local"

      - name: Install dependencies (safe if requirements missing)
        run: |
          python -m pip install --upgrade pip
          if [ -f scw/requirements.txt ]; then
            python -m pip install -r scw/requirements.txt
          else
            echo "No requirements.txt found â€” continuing"
          fi

      - name: Run SCW core
        run: |
          echo "Running SCW core..."
          python scw/scw_core.py \
            --command "${CMD}" \
            --target "${TARGET}" \
            --org "${ORG}" \
            --base "${BASE}" \
            --dry "${DRY}" \
            --allow "${ALLOW}"

      - name: Post-run summary
        if: always()
        run: |
          echo "SCW finished with status: ${{ job.status }}"
          echo "Command: $CMD"
          echo "Target repo: $TARGET"
          echo "Dry run: $DRY"
