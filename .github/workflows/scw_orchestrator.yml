name: StegVerse SCW Orchestrator

on:
  workflow_dispatch:
    inputs:
      command:
        description: "SCW command (self-test, autopatch, org-scan)"
        required: true
        default: "self-test"
      target_repo:
        description: "Repo to operate on (e.g. StegVerse-Labs/TVC)"
        required: false
        default: ""
      org:
        description: "Org (StegVerse-Labs or StegVerse)"
        required: false
        default: "StegVerse-Labs"
      base_branch:
        description: "Base branch for autopatch PR"
        required: false
        default: "main"
      dry_run:
        description: "If true, SCW will not push or open PRs"
        type: boolean
        required: false
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  scw:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout SCW
        uses: actions/checkout@v4

      - name: Choose token
        id: token_map
        run: |
          if [ "${{ github.event.inputs.org }}" = "StegVerse-Labs" ]; then
            echo "GH_TOKEN=${{ secrets.GH_STEGVERSE_LABS_AI_TOKEN }}" >> $GITHUB_ENV
          else
            echo "GH_TOKEN=${{ secrets.GH_STEGVERSE_AI_TOKEN }}" >> $GITHUB_ENV
          fi

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f scw/requirements.txt ]; then
              pip install -r scw/requirements.txt
          fi

      - name: Run SCW Core
        run: |
          python -m scw.scw_core \
            "${{ github.event.inputs.command }}" \
            --org "${{ github.event.inputs.org }}" \
            --target-repo "${{ github.event.inputs.target_repo }}" \
            --dry-run "${{ github.event.inputs.dry_run }}" \
            --base-branch "${{ github.event.inputs.base_branch }}"
